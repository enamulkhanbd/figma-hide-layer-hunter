<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hidden Layer Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Inter global -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff; --fg:#111111; --muted:#6b7280; --border:#e5e7eb;
      --hover:rgba(0,0,0,.06); --hover2:rgba(0,0,0,.08); --accent:#3b82f6;
      --danger:#ef4444;

      --gutter-x: 12px;
      --chk-size: 20px;
      --chk-hit-x: 6px;
      --chk-hit-y: 2px;
      --chk-gap: 4px;
    }

    *{ font-family:'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }

    html,body{ margin:0; padding:0; background:var(--bg); color:var(--fg); font-size:14px; line-height:20px; }

    /* prevent text selection drag */
    html, body, .wrap, header, .toolbar, .list, .layer-row, .chk-wrap, .layer-name, .btn, .target-btn, .footer {
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
    }
    input[type="text"], input[type="search"], textarea { user-select: text; }

    .wrap{display:flex; flex-direction:column; height:100vh; min-height:480px;}

    header{ display:flex; align-items:center; justify-content:space-between; padding:10px var(--gutter-x); border-bottom:1px solid var(--border); gap:4px; }
    header h1{font-size:14px; font-weight:600; margin:0;}

    .btn{
      display:inline-flex; align-items:center; gap:4px;
      border:1px solid var(--border); background:#fff;
      padding:6px 10px; border-radius:8px; cursor:pointer; user-select:none;
      font-size:14px; font-weight:500;
    }
    .btn[disabled]{opacity:.5; cursor:not-allowed;}
    .btn svg{width:16px; height:16px;}

    /* Delete button: red hover, white text & icon */
    #deleteBtn:not([disabled]):hover{ background: var(--danger); border-color: var(--danger); color:#fff; }
    #deleteBtn:not([disabled]):active{ background:#dc2626; border-color:#dc2626; }

    /* Toolbar */
    .toolbar{
      display:flex; align-items:center; justify-content: space-between;
      padding:8px var(--gutter-x);
      border-bottom:1px solid var(--border); flex-wrap:wrap;
      gap:16px;
    }

    .empty{padding:16px var(--gutter-x); color:var(--muted);}
    .list{padding:4px var(--gutter-x) 12px var(--gutter-x); overflow:auto; flex:1 1 auto;}

    /* rows: no global hover; only target icon hovers */
    .layer-row{ display:flex; align-items:center; justify-content:space-between; gap:4px; padding:6px 0; border-radius:8px; }
    .layer-left{ display:flex; align-items:center; min-width:0; flex:1 1 auto; gap:8px; } /* name â†’ badge gap = 8px */

    .chk-wrap{ display:inline-flex; align-items:center; gap:var(--chk-gap); padding: var(--chk-hit-y) var(--chk-hit-x) var(--chk-hit-y) 0; border-radius:6px; cursor:pointer; min-width:0; }
    .chk{ position:absolute; opacity:0; width:0; height:0; margin:0; padding:0; }
    .chk-icon{ width:var(--chk-size); height:var(--chk-size); display:inline-flex; align-items:center; justify-content:center; line-height:1; flex:0 0 auto; }
    .chk-icon svg{ width:100%; height:100%; display:block; }

    .chk-icon .icon-checked{ display:none; }
    .chk-icon .icon-indet{ display:none; }
    .chk:checked + .chk-icon .icon-unchecked{ display:none; }
    .chk:checked + .chk-icon .icon-checked{ display:block; }
    .chk:indeterminate + .chk-icon .icon-unchecked{ display:none; }
    .chk:indeterminate + .chk-icon .icon-checked{ display:none; }
    .chk:indeterminate + .chk-icon .icon-indet{ display:block; }
    .chk:focus-visible + .chk-icon{ outline:2px solid var(--accent); outline-offset:2px; border-radius:4px; }

    .layer-name{ font-size:14px; font-weight:500; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1 1 auto; }

    /* INSTANCE badge */
    .badge{
      display:inline-flex; align-items:center;
      font-size:12px; font-weight:500; line-height:1;
      padding:2px 4px; border-radius:6px; text-transform:uppercase;
      border:1px solid rgba(138,56,245,.12);
      background:rgba(138,56,245,.12);
      color:#8A38F5;
      flex:0 0 auto;
    }

    .target-btn{ flex:0 0 auto; border:none; background:transparent; padding:6px; border-radius:6px; cursor:pointer; }
    .target-btn:hover{ background:var(--hover2); }
    .target-btn svg{width:18px; height:18px; display:block;}

    /* Select-all disabled look */
    #selectAllWrap.is-disabled{ opacity:.5; cursor:not-allowed; }
    #selectAllWrap.is-disabled .chk-icon, #selectAllWrap.is-disabled .layer-name{ pointer-events:none; }
    #selectAllWrap .chk:disabled + .chk-icon{ opacity:.6; }
    #selectAllWrap .chk:disabled + .chk-icon + .layer-name{ color:var(--muted); }

    /* Footer spec */
    .footer{ display:flex; align-items:center; justify-content:space-between; padding:8px var(--gutter-x); border-top:1px solid var(--border); color:#AAAAAA; font-size:12px; font-weight:400; flex:0 0 auto; }
    .footer .brand{ font-weight:400; }
    .footer .ver{ font-style:normal; font-weight:400; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Hidden Layer Finder</h1>
      <button id="scanBtn" class="btn" title="Scan selection">
        <!-- NEW Scan/Rescan icon (uses currentColor) -->
        <svg viewBox="0 0 25 25" fill="none" aria-hidden="true">
          <path fill="currentColor" d="M12.9857 20.4207C10.7524 20.4207 8.85238 19.6457 7.28572 18.0957C5.71905 16.5457 4.93572 14.654 4.93572 12.4207V12.2457L4.03572 13.1457C3.85238 13.329 3.61905 13.4207 3.33572 13.4207C3.05238 13.4207 2.81905 13.329 2.63572 13.1457C2.45238 12.9623 2.36072 12.729 2.36072 12.4457C2.36072 12.1623 2.45238 11.929 2.63572 11.7457L5.23572 9.14565C5.43572 8.94565 5.66905 8.84565 5.93572 8.84565C6.20238 8.84565 6.43572 8.94565 6.63572 9.14565L9.23572 11.7457C9.41905 11.929 9.51072 12.1623 9.51072 12.4457C9.51072 12.729 9.41905 12.9623 9.23572 13.1457C9.05238 13.329 8.81905 13.4207 8.53572 13.4207C8.25238 13.4207 8.01905 13.329 7.83572 13.1457L6.93572 12.2457V12.4207C6.93572 14.0873 7.52322 15.504 8.69822 16.6707C9.87322 17.8373 11.3024 18.4207 12.9857 18.4207C13.2524 18.4207 13.5149 18.404 13.7732 18.3707C14.0316 18.3373 14.2857 18.279 14.5357 18.1957C14.8191 18.1123 15.0857 18.1207 15.3357 18.2207C15.5857 18.3207 15.7774 18.4957 15.9107 18.7457C16.0441 19.0123 16.0566 19.2748 15.9482 19.5332C15.8399 19.7915 15.6441 19.9623 15.3607 20.0457C14.9774 20.179 14.5857 20.2748 14.1857 20.3332C13.7857 20.3915 13.3857 20.4207 12.9857 20.4207ZM12.8857 6.42065C12.6191 6.42065 12.3566 6.43732 12.0982 6.47065C11.8399 6.50399 11.5857 6.56232 11.3357 6.64565C11.0524 6.72899 10.7816 6.72065 10.5232 6.62065C10.2649 6.52065 10.0691 6.34565 9.93572 6.09565C9.80238 5.84565 9.78988 5.59149 9.89822 5.33315C10.0066 5.07482 10.1941 4.90399 10.4607 4.82065C10.8607 4.68732 11.2607 4.58732 11.6607 4.52065C12.0607 4.45399 12.4691 4.42065 12.8857 4.42065C15.1191 4.42065 17.0191 5.19565 18.5857 6.74565C20.1524 8.29565 20.9357 10.1873 20.9357 12.4207V12.5957L21.8357 11.6957C22.0191 11.5123 22.2524 11.4207 22.5357 11.4207C22.8191 11.4207 23.0524 11.5123 23.2357 11.6957C23.4191 11.879 23.5107 12.1123 23.5107 12.3957C23.5107 12.679 23.4191 12.9123 23.2357 13.0957L20.6357 15.6957C20.4357 15.8957 20.2024 15.9957 19.9357 15.9957C19.6691 15.9957 19.4357 15.8957 19.2357 15.6957L16.6357 13.0957C16.4524 12.9123 16.3607 12.679 16.3607 12.3957C16.3607 12.1123 16.4524 11.879 16.6357 11.6957C16.8191 11.5123 17.0524 11.4207 17.3357 11.4207C17.6191 11.4207 17.8524 11.5123 18.0357 11.6957L18.9357 12.5957V12.4207C18.9357 10.754 18.3482 9.33732 17.1732 8.17065C15.9982 7.00399 14.5691 6.42065 12.8857 6.42065Z"/>
        </svg>
        <span id="scanBtnLabel">Scan</span>
      </button>
    </header>

    <div class="toolbar">
      <!-- Left: Select all -->
      <label class="chk-wrap is-disabled" id="selectAllWrap" title="Select all hidden layers">
        <input class="chk" type="checkbox" id="chkAll" aria-label="Select all hidden layers" disabled />
        <span class="chk-icon" aria-hidden="true">
          <!-- Unchecked -->
          <svg class="icon-unchecked" viewBox="0 0 24 24" fill="none">
            <path d="M5 21C4.45 21 3.97917 20.8042 3.5875 20.4125C3.19583 20.0208 3 19.55 3 19V5C3 4.45 3.19583 3.97917 3.5875 3.5875C3.97917 3.19583 4.45 3 5 3H19C19.55 3 20.0208 3.19583 20.4125 3.5875C20.8042 3.97917 21 4.45 21 5V19C21 19.55 20.8042 20.0208 20.4125 20.4125C20.0208 20.8042 19.55 21 19 21H5ZM5 19H19V5H5V19Z" fill="#000"/>
          </svg>
          <!-- Checked -->
          <svg class="icon-checked" viewBox="0 0 24 24" fill="none">
            <path d="M10.6 13.4L8.45 11.25C8.26667 11.0667 8.03333 10.975 7.75 10.975C7.46667 10.975 7.23333 11.0667 7.05 11.25C6.86667 11.4333 6.775 11.6667 6.775 11.95C6.775 12.2333 6.86667 12.4667 7.05 12.65L9.9 15.5C10.1 15.7 10.3333 15.8 10.6 15.8C10.8667 15.8 11.1 15.7 11.3 15.5L16.95 9.85C17.1333 9.66667 17.225 9.43333 17.225 9.15C17.225 8.86667 17.1333 8.63333 16.95 8.45C16.7667 8.26667 16.5333 8.175 16.25 8.175C15.9667 8.175 15.7333 8.26667 15.55 8.45L10.6 13.4ZM5 21C4.45 21 3.97917 20.8042 3.5875 20.4125C3.19583 20.0208 3 19.55 3 19V5C3 4.45 3.19583 3.97917 3.5875 3.5875C3.97917 3.19583 4.45 3 5 3H19C19.55 3 20.0208 3.19583 20.4125 3.5875C20.8042 3.97917 21 4.45 21 5V19C21 19.55 20.8042 20.0208 20.4125 20.4125C20.0208 20.8042 19.55 21 19 21H5Z" fill="#4caf4f"/>
          </svg>
          <!-- Indeterminate -->
          <svg class="icon-indet" viewBox="0 0 24 25" fill="none">
            <path d="M8 13.5H16C16.2833 13.5 16.5208 13.4042 16.7125 13.2125C16.9042 13.0208 17 12.7833 17 12.5C17 12.2167 16.9042 11.9792 16.7125 11.7875C16.5208 11.5958 16.2833 11.5 16 11.5H8C7.71667 11.5 7.47917 11.5958 7.2875 11.7875C7.09583 11.9792 7 12.2167 7 12.5C7 12.7833 7.09583 13.0208 7.2875 13.2125C7.47917 13.4042 7.71667 13.5 8 13.5ZM5 21.5C4.45 21.5 3.97917 21.3042 3.5875 20.9125C3.19583 20.5208 3 20.05 3 19.5V5.5C3 4.95 3.19583 4.47917 3.5875 4.0875C3.97917 3.69583 4.45 3.5 5 3.5H19C19.55 3.5 20.0208 3.69583 20.4125 4.0875C20.8042 4.47917 21 4.95 21 5.5V19.5C21 20.05 20.8042 20.5208 20.4125 20.9125C20.0208 21.3042 19.55 21.5 19 21.5H5Z" fill="#4caf4f"/>
          </svg>
        </span>
        <span class="layer-name">Select all</span>
      </label>

      <!-- Right: Delete -->
      <button id="deleteBtn" class="btn" title="Delete selected layers" disabled>
        <!-- Delete icon (currentColor so it turns white on hover) -->
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path fill="currentColor" d="M7 21C6.45 21 5.97917 20.8042 5.5875 20.4125C5.19583 20.0208 5 19.55 5 19V6C4.71667 6 4.47917 5.90417 4.2875 5.7125C4.09583 5.52083 4 5.28333 4 5C4 4.71667 4.09583 4.47917 4.2875 4.2875C4.47917 4.09583 4.71667 4 5 4H9C9 3.71667 9.09583 3.47917 9.2875 3.2875C9.47917 3.09583 9.71667 3 10 3H14C14.2833 3 14.5208 3.09583 14.7125 3.2875C14.9042 3.47917 15 3.71667 15 4H19C19.2833 4 19.5208 4.09583 19.7125 4.2875C19.9042 4.47917 20 4.71667 20 5C20 5.28333 19.9042 5.52083 19.7125 5.7125C19.5208 5.90417 19.2833 6 19 6V19C19 19.55 18.8042 20.0208 18.4125 20.4125C18.0208 20.8042 17.55 21 17 21H7ZM17 6H7V19H17V6ZM10 17C10.2833 17 10.5208 16.9042 10.7125 16.7125C10.9042 16.5208 11 16.2833 11 16V9C11 8.71667 10.9042 8.47917 10.7125 8.2875C10.5208 8.09583 10.2833 8 10 8C9.71667 8 9.47917 8.09583 9.2875 8.2875C9.09583 8.47917 9 8.71667 9 9V16C9 16.2833 9.09583 16.5208 9.2875 16.7125C9.47917 16.9042 9.71667 17 10 17ZM14 17C14.2833 17 14.5208 16.9042 14.7125 16.7125C14.9042 16.5208 15 16.2833 15 16V9C15 8.71667 14.9042 8.47917 14.7125 8.2875C14.5208 8.09583 14.2833 8 14 8C13.7167 8 13.4792 8.09583 13.2875 8.2875C13.0958 8.47917 13 8.71667 13 9V16C13 16.2833 13.0958 16.5208 13.2875 16.7125C13.4792 16.9042 13.7167 17 14 17Z"/>
        </svg>
        <span class="btn-label">Delete Selected (<span id="selCount">0</span>)</span>
      </button>
    </div>

    <div id="empty" class="empty" style="display:none;">
      Select a frame/group/layer and click <b>Scan</b> to list top-level hidden layers (components &amp; instances are ignored).
    </div>

    <div id="list" class="list"></div>

    <!-- Footer -->
    <div class="footer" aria-label="Plugin credits">
      <span class="brand">JustGo UX Team</span>
      <span class="ver">v2.0.1 Beta</span>
    </div>
  </div>

  <script>
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');
    const scanBtn = document.getElementById('scanBtn');
    const scanBtnLabel = document.getElementById('scanBtnLabel');

    const selectAllWrap = document.getElementById('selectAllWrap');
    const chkAll = document.getElementById('chkAll');
    const deleteBtn = document.getElementById('deleteBtn');
    const selCountEl = document.getElementById('selCount');

    let currentLayers = []; // [{id,name,isInstance}]
    let selectedIds = new Set();

    let hasUserScanned = false;
    let scannedOnce = false;

    const EMPTY_HINT = 'Select a frame/group/layer and click <b>Scan</b> to list top-level hidden layers (components &amp; instances are ignored).';
    function setEmpty(html) { emptyEl.innerHTML = html; }

    function escapeHtml(s){ return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    const escapeAttr = escapeHtml;

    function updateSelectionUI(){
      const count = selectedIds.size;
      const allCount = currentLayers.length;

      selCountEl.textContent = String(count);
      deleteBtn.disabled = count === 0;

      const enableSelectAll = hasUserScanned && allCount >= 2;
      chkAll.disabled = !enableSelectAll;
      selectAllWrap.classList.toggle('is-disabled', !enableSelectAll);

      if (!enableSelectAll) {
        chkAll.checked = false;
        chkAll.indeterminate = false;
        return;
      }

      const allSelected = allCount > 0 && count === allCount;
      const noneSelected = count === 0;
      chkAll.checked = allSelected;
      chkAll.indeterminate = !noneSelected && !allSelected;
    }

    function updateScanButtonLabel(){
      scanBtnLabel.textContent = scannedOnce ? 'Rescan' : 'Scan';
      scanBtn.title = scannedOnce ? 'Rescan selection' : 'Scan selection';
    }

    function renderLayers(payload){
      const { layers = [] } = payload || {};
      currentLayers = layers.slice();
      selectedIds = new Set();

      if (!layers.length){
        listEl.innerHTML = '';
        setEmpty('No hidden layers found in the current selection.');
        emptyEl.style.display = '';
        updateSelectionUI();
        return;
      }
      emptyEl.style.display = 'none';

      const html = layers.map(item => `
        <div class="layer-row" data-id="${item.id}" title="${escapeAttr(item.name)}">
          <div class="layer-left">
            <label class="chk-wrap">
              <input class="chk" type="checkbox" data-id="${item.id}" aria-label="Select ${escapeAttr(item.name)}" />
              <span class="chk-icon" aria-hidden="true">
                <!-- Unchecked -->
                <svg class="icon-unchecked" viewBox="0 0 24 24" fill="none">
                  <path d="M5 21C4.45 21 3.97917 20.8042 3.5875 20.4125C3.19583 20.0208 3 19.55 3 19V5C3 4.45 3.19583 3.97917 3.5875 3.5875C3.97917 3.19583 4.45 3 5 3H19C19.55 3 20.0208 3.19583 20.4125 3.5875C20.8042 3.97917 21 4.45 21 5V19C21 19.55 20.8042 20.0208 20.4125 20.4125C20.0208 20.8042 19.55 21 19 21H5ZM5 19H19V5H5V19Z" fill="#000"/>
                </svg>
                <!-- Checked -->
                <svg class="icon-checked" viewBox="0 0 24 24" fill="none">
                  <path d="M10.6 13.4L8.45 11.25C8.26667 11.0667 8.03333 10.975 7.75 10.975C7.46667 10.975 7.23333 11.0667 7.05 11.25C6.86667 11.4333 6.775 11.6667 6.775 11.95C6.775 12.2333 6.86667 12.4667 7.05 12.65L9.9 15.5C10.1 15.7 10.3333 15.8 10.6 15.8C10.8667 15.8 11.1 15.7 11.3 15.5L16.95 9.85C17.1333 9.66667 17.225 9.43333 17.225 9.15C17.225 8.86667 17.1333 8.63333 16.95 8.45C16.7667 8.26667 16.5333 8.175 16.25 8.175C15.9667 8.175 15.7333 8.26667 15.55 8.45L10.6 13.4ZM5 21C4.45 21 3.97917 20.8042 3.5875 20.4125C3.19583 20.0208 3 19.55 3 19V5C3 4.45 3.19583 3.97917 3.5875 3.5875C3.97917 3.19583 4.45 3 5 3H19C19.55 3 20.0208 3.19583 20.4125 3.5875C20.8042 3.97917 21 4.45 21 5V19C21 19.55 20.8042 20.0208 20.4125 20.4125C20.0208 20.8042 19.55 21 19 21H5Z" fill="#4caf4f"/>
                </svg>
              </span>
              <span class="layer-name">${escapeHtml(item.name)}</span>
            </label>
            ${item.isInstance ? '<span class="badge" title="Instance">INSTANCE</span>' : ''}
          </div>

          <button class="target-btn" aria-label="Focus ${escapeAttr(item.name)}" data-id="${item.id}" title="Focus">
            <!-- Target icon -->
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path fill="currentColor" d="M11 21.95V20.95C8.91672 20.7167 7.12922 19.8542 5.63755 18.3625C4.14588 16.8709 3.28338 15.0834 3.05005 13H2.05005C1.76672 13 1.52922 12.9042 1.33755 12.7125C1.14588 12.5209 1.05005 12.2834 1.05005 12C1.05005 11.7167 1.14588 11.4792 1.33755 11.2875C1.52922 11.0959 1.76672 11 2.05005 11H3.05005C3.28338 8.91672 4.14588 7.12922 5.63755 5.63755C7.12922 4.14588 8.91672 3.28338 11 3.05005V2.05005C11 1.76672 11.0959 1.52922 11.2875 1.33755C11.4792 1.14588 11.7167 1.05005 12 1.05005C12.2834 1.05005 12.5209 1.14588 12.7125 1.33755C12.9042 1.52922 13 1.76672 13 2.05005V3.05005C15.0834 3.28338 16.8709 4.14588 18.3625 5.63755C19.8542 7.12922 20.7167 8.91672 20.95 11H21.95C22.2334 11 22.4709 11.0959 22.6625 11.2875C22.8542 11.4792 22.95 11.7167 22.95 12C22.95 12.2834 22.8542 12.5209 22.6625 12.7125C22.4709 12.9042 22.2334 13 21.95 13H20.95C20.7167 15.0834 19.8542 16.8709 18.3625 18.3625C16.8709 19.8542 15.0834 20.7167 13 20.95V21.95C13 22.2334 12.9042 22.4709 12.7125 22.6625C12.5209 22.8542 12.2834 22.95 12 22.95C11.7167 22.95 11.4792 22.8542 11.2875 22.6625C11.0959 22.4709 11 22.2334 11 21.95ZM12 19C13.9334 19 15.5834 18.3167 16.95 16.95C18.3167 15.5834 19 13.9334 19 12C19 10.0667 18.3167 8.41672 16.95 7.05005C15.5834 5.68338 13.9334 5.00005 12 5.00005C10.0667 5.00005 8.41672 5.68338 7.05005 7.05005C5.68338 8.41672 5.00005 10.0667 5.00005 12C5.00005 13.9334 5.68338 15.5834 7.05005 16.95C8.41672 18.3167 10.0667 19 12 19ZM12 16C10.9 16 9.95838 15.6084 9.17505 14.825C8.39172 14.0417 8.00005 13.1 8.00005 12C8.00005 10.9 8.39172 9.95838 9.17505 9.17505C9.95838 8.39172 10.9 8.00005 12 8.00005C13.1 8.00005 14.0417 8.39172 14.825 9.17505C15.6084 9.95838 16 10.9 16 12C16 13.1 15.6084 14.0417 14.825 14.825C14.0417 15.6084 13.1 16 12 16ZM12 14C12.55 14 13.0209 13.8042 13.4125 13.4125C13.8042 13.0209 14 12.55 14 12C14 11.45 13.8042 10.9792 13.4125 10.5875C13.0209 10.1959 12.55 10 12 10C11.45 10 10.9792 10.1959 10.5875 10.5875C10.1959 10.9792 10 11.45 10 12C10 12.55 10.1959 13.0209 10.5875 13.4125C10.9792 13.8042 11.45 14 12 14Z"/>
            </svg>
          </button>
        </div>
      `).join('');

      listEl.innerHTML = html;
      updateSelectionUI();
    }

    // --- Events ---
    scanBtn.addEventListener('click', () => {
      hasUserScanned = true;
      parent.postMessage({ pluginMessage: { type: 'search-again' } }, '*');
    });

    deleteBtn.addEventListener('click', () => {
      const ids = Array.from(selectedIds);
      if (!ids.length) return;
      deleteBtn.disabled = true;
      parent.postMessage({ pluginMessage: { type: 'delete-selected', ids } }, '*');
    });

    // Select All
    chkAll.addEventListener('change', () => {
      if (chkAll.disabled) return;
      const allCount = currentLayers.length;
      if (!allCount) {
        chkAll.checked = false;
        chkAll.indeterminate = false;
        return;
      }
      if (chkAll.checked) {
        selectedIds = new Set(currentLayers.map(l => l.id));
        listEl.querySelectorAll('.chk').forEach(ch => (ch.checked = true));
      } else {
        selectedIds.clear();
        listEl.querySelectorAll('.chk').forEach(ch => (ch.checked = false));
      }
      updateSelectionUI();
    });

    // Row checkbox
    listEl.addEventListener('change', (e) => {
      const chk = e.target.closest('.chk');
      if (!chk) return;
      const id = chk.dataset.id;
      if (!id) return;
      if (chk.checked) selectedIds.add(id);
      else selectedIds.delete(id);
      updateSelectionUI();
    });

    // Target icon click
    listEl.addEventListener('click', (e) => {
      const targetBtn = e.target.closest('.target-btn');
      if (!targetBtn) return;
      const id = targetBtn.dataset.id;
      if (!id) return;
      parent.postMessage({ pluginMessage: { type: 'zoom-to-layer', id } }, '*');

      const row = targetBtn.closest('.layer-row');
      const chk = row ? row.querySelector('.chk') : null;
      if (chk) {
        chk.checked = true;
        selectedIds.add(id);
        updateSelectionUI();
      }
    });

    // --- Messages from plugin ---
    window.onmessage = (event) => {
      const msg = event.data && event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'render-layers') {
        if (hasUserScanned) scannedOnce = true;
        updateScanButtonLabel();
        renderLayers(msg);
      }

      if (msg.type === 'prompt-selection') {
        renderLayers({ layers: [] });
        setEmpty(EMPTY_HINT);
        if (!hasUserScanned) scannedOnce = false;
        updateScanButtonLabel();
      }

      if (msg.type === 'deleted-ids' && Array.isArray(msg.ids)) {
        const gone = new Set(msg.ids);
        currentLayers = currentLayers.filter(l => !gone.has(l.id));
        selectedIds = new Set([...selectedIds].filter(id => !gone.has(id)));
        msg.ids.forEach((id) => {
          const row = listEl.querySelector(`.layer-row[data-id="${(id+'').replace(/"/g,'\\"')}"]`);
          if (row) row.remove();
        });
        if (currentLayers.length === 0) {
          setEmpty('No hidden layers found in the current selection.');
          emptyEl.style.display = '';
        }
        updateSelectionUI();
      }
    };

    // Init
    chkAll.disabled = true; chkAll.checked = false; chkAll.indeterminate = false;
    selectAllWrap.classList.add('is-disabled');
    setEmpty(EMPTY_HINT);
    updateScanButtonLabel();
    emptyEl.style.display = '';
    updateSelectionUI();
  </script>
</body>
</html>
