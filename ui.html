<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hidden Layer Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Inter global -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff; --fg:#111111; --muted:#6b7280; --border:#e5e7eb;
      --hover:rgba(0,0,0,.06); --hover2:rgba(0,0,0,.08); --accent:#3b82f6;
      --danger:#ef4444;

      --gutter-x: 12px;
      --chk-size: 20px;
      --chk-hit-x: 6px;
      --chk-hit-y: 2px;
      --chk-gap: 4px;
    }

    *{ font-family:'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }

    html,body{ margin:0; padding:0; background:var(--bg); color:var(--fg); font-size:14px; line-height:20px; }

    /* prevent text selection drag */
    html, body, .wrap, header, .toolbar, .list, .layer-row, .chk-wrap, .layer-name, .btn, .target-btn, .footer {
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
    }
    input[type="text"], input[type="search"], textarea { user-select: text; }

    .wrap{display:flex; flex-direction:column; height:100vh; min-height:480px;}

    header{ display:flex; align-items:center; justify-content:space-between; padding:10px var(--gutter-x); border-bottom:1px solid var(--border); gap:4px; }
    header h1{font-size:14px; font-weight:600; margin:0;}

    .btn{
      display:inline-flex; align-items:center; gap:4px;
      border:1px solid var(--border); background:#fff;
      padding:6px 10px; border-radius:8px; cursor:pointer; user-select:none;
      font-size:14px; font-weight:500;
    }
    .btn[disabled]{opacity:.5; cursor:not-allowed;}
    .btn svg{width:16px; height:16px;}

    /* Delete button hover */
    #deleteBtn:not([disabled]):hover{ background: var(--danger); border-color: var(--danger); color:#fff; }
    #deleteBtn:not([disabled]):hover svg{ stroke:#fff; }
    #deleteBtn:not([disabled]):active{ background:#dc2626; border-color:#dc2626; }

    /* Toolbar */
    .toolbar{
      display:flex; align-items:center; justify-content: space-between;
      padding:8px var(--gutter-x);
      border-bottom:1px solid var(--border); flex-wrap:wrap;
      gap:16px;
    }

    .empty{padding:16px var(--gutter-x); color:var(--muted);}
    .list{padding:4px var(--gutter-x) 12px var(--gutter-x); overflow:auto; flex:1 1 auto;}

    /* rows: no global hover; only target icon hovers */
    .layer-row{ display:flex; align-items:center; justify-content:space-between; gap:4px; padding:6px 0; border-radius:8px; }
    .layer-left{ display:flex; align-items:center; min-width:0; flex:1 1 auto; gap:8px; } /* name â†’ badge gap = 8px */

    .chk-wrap{ display:inline-flex; align-items:center; gap:var(--chk-gap); padding: var(--chk-hit-y) var(--chk-hit-x) var(--chk-hit-y) 0; border-radius:6px; cursor:pointer; min-width:0; }
    .chk{ position:absolute; opacity:0; width:0; height:0; margin:0; padding:0; }
    .chk-icon{ width:var(--chk-size); height:var(--chk-size); display:inline-flex; align-items:center; justify-content:center; line-height:1; flex:0 0 auto; }
    .chk-icon svg{ width:100%; height:100%; display:block; }

    .chk-icon .icon-checked{ display:none; }
    .chk-icon .icon-indet{ display:none; }
    .chk:checked + .chk-icon .icon-unchecked{ display:none; }
    .chk:checked + .chk-icon .icon-checked{ display:block; }
    .chk:indeterminate + .chk-icon .icon-unchecked{ display:none; }
    .chk:indeterminate + .chk-icon .icon-checked{ display:none; }
    .chk:indeterminate + .chk-icon .icon-indet{ display:block; }
    .chk:focus-visible + .chk-icon{ outline:2px solid var(--accent); outline-offset:2px; border-radius:4px; }

    .layer-name{ font-size:14px; font-weight:500; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1 1 auto; }

    /* INSTANCE badge */
    .badge{
      display:inline-flex; align-items:center;
      font-size:11px; font-weight:500; line-height:1;
      padding:2px 4px; border-radius:6px; text-transform:uppercase;
      border:1px solid rgba(138,56,245,.12);
      background:rgba(138,56,245,.12);
      color:#8A38F5;
      flex:0 0 auto;
    }

    .target-btn{ flex:0 0 auto; border:none; background:transparent; padding:6px; border-radius:6px; cursor:pointer; }
    .target-btn:hover{ background:var(--hover2); }
    .target-btn svg{width:18px; height:18px; display:block;}

    /* Select-all disabled look */
    #selectAllWrap.is-disabled{ opacity:.5; cursor:not-allowed; }
    #selectAllWrap.is-disabled .chk-icon, #selectAllWrap.is-disabled .layer-name{ pointer-events:none; }
    #selectAllWrap .chk:disabled + .chk-icon{ opacity:.6; }
    #selectAllWrap .chk:disabled + .chk-icon + .layer-name{ color:var(--muted); }

    /* Footer spec */
    .footer{ display:flex; align-items:center; justify-content:space-between; padding:8px var(--gutter-x); border-top:1px solid var(--border); color:#AAAAAA; font-size:12px; font-weight:400; flex:0 0 auto; }
    .footer .brand{ font-weight:400; }
    .footer .ver{ font-style:normal; font-weight:400; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Hidden Layer Finder</h1>
      <button id="scanBtn" class="btn" title="Scan selection">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <polyline points="23 4 23 10 17 10"></polyline>
          <polyline points="1 20 1 14 7 14"></polyline>
          <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"></path>
          <path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"></path>
        </svg>
        <span id="scanBtnLabel">Scan</span>
      </button>
    </header>

    <div class="toolbar">
      <!-- Left: Select all -->
      <label class="chk-wrap is-disabled" id="selectAllWrap" title="Select all hidden layers">
        <input class="chk" type="checkbox" id="chkAll" aria-label="Select all hidden layers" disabled />
        <span class="chk-icon" aria-hidden="true">
          <!-- Unchecked -->
          <svg class="icon-unchecked" viewBox="0 0 24 24" fill="none">
            <path d="M5 21C4.45 21 3.97917 20.8042 3.5875 20.4125C3.19583 20.0208 3 19.55 3 19V5C3 4.45 3.19583 3.97917 3.5875 3.5875C3.97917 3.19583 4.45 3 5 3H19C19.55 3 20.0208 3.19583 20.4125 3.5875C20.8042 3.97917 21 4.45 21 5V19C21 19.55 20.8042 20.0208 20.4125 20.4125C20.0208 20.8042 19.55 21 19 21H5ZM5 19H19V5H5V19Z" fill="#000"/>
          </svg>
          <!-- Checked -->
          <svg class="icon-checked" viewBox="0 0 24 24" fill="none">
            <path d="M10.6 13.4L8.45 11.25C8.26667 11.0667 8.03333 10.975 7.75 10.975C7.46667 10.975 7.23333 11.0667 7.05 11.25C6.86667 11.4333 6.775 11.6667 6.775 11.95C6.775 12.2333 6.86667 12.4667 7.05 12.65L9.9 15.5C10.1 15.7 10.3333 15.8 10.6 15.8C10.8667 15.8 11.1 15.7 11.3 15.5L16.95 9.85C17.1333 9.66667 17.225 9.43333 17.225 9.15C17.225 8.86667 17.1333 8.63333 16.95 8.45C16.7667 8.26667 16.5333 8.175 16.25 8.175C15.9667 8.175 15.7333 8.26667 15.55 8.45L10.6 13.4ZM5 21C4.45 21 3.97917 20.8042 3.5875 20.4125C3.19583 20.0208 3 19.55 3 19V5C3 4.45 3.19583 3.97917 3.5875 3.5875C3.97917 3.19583 4.45 3 5 3H19C19.55 3 20.0208 3.19583 20.4125 3.5875C20.8042 3.97917 21 4.45 21 5V19C21 19.55 20.8042 20.0208 20.4125 20.4125C20.0208 20.8042 19.55 21 19 21H5Z" fill="#4caf4f"/>
          </svg>
          <!-- Indeterminate -->
          <svg class="icon-indet" viewBox="0 0 24 25" fill="none">
            <path d="M8 13.5H16C16.2833 13.5 16.5208 13.4042 16.7125 13.2125C16.9042 13.0208 17 12.7833 17 12.5C17 12.2167 16.9042 11.9792 16.7125 11.7875C16.5208 11.5958 16.2833 11.5 16 11.5H8C7.71667 11.5 7.47917 11.5958 7.2875 11.7875C7.09583 11.9792 7 12.2167 7 12.5C7 12.7833 7.09583 13.0208 7.2875 13.2125C7.47917 13.4042 7.71667 13.5 8 13.5ZM5 21.5C4.45 21.5 3.97917 21.3042 3.5875 20.9125C3.19583 20.5208 3 20.05 3 19.5V5.5C3 4.95 3.19583 4.47917 3.5875 4.0875C3.97917 3.69583 4.45 3.5 5 3.5H19C19.55 3.5 20.0208 3.69583 20.4125 4.0875C20.8042 4.47917 21 4.95 21 5.5V19.5C21 20.05 20.8042 20.5208 20.4125 20.9125C20.0208 21.3042 19.55 21.5 19 21.5H5Z" fill="#4caf4f"/>
          </svg>
        </span>
        <span class="layer-name">Select all</span>
      </label>

      <!-- Right: Delete -->
      <button id="deleteBtn" class="btn" title="Delete selected layers" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
          <path d="M10 11v6M14 11v6"></path>
          <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
        </svg>
        <span class="btn-label">Delete Selected (<span id="selCount">0</span>)</span>
      </button>
    </div>

    <div id="empty" class="empty" style="display:none;">
      Select a frame/group/layer and click <b>Scan</b> to list top-level hidden layers (components &amp; instances are ignored).
    </div>

    <div id="list" class="list"></div>

    <!-- Footer -->
    <div class="footer" aria-label="Plugin credits">
      <span class="brand">JustGo UX Team</span>
      <span class="ver">v2.0.1 Beta</span>
    </div>
  </div>

  <script>
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');
    const scanBtn = document.getElementById('scanBtn');
    const scanBtnLabel = document.getElementById('scanBtnLabel');

    const selectAllWrap = document.getElementById('selectAllWrap');
    const chkAll = document.getElementById('chkAll');
    const deleteBtn = document.getElementById('deleteBtn');
    const selCountEl = document.getElementById('selCount');

    let currentLayers = []; // [{id,name,isInstance}]
    let selectedIds = new Set();

    let hasUserScanned = false;
    let scannedOnce = false;

    const EMPTY_HINT = 'Select a frame/group/layer and click <b>Scan</b> to list top-level hidden layers (components &amp; instances are ignored).';
    function setEmpty(html) { emptyEl.innerHTML = html; }

    function escapeHtml(s){ return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    const escapeAttr = escapeHtml;

    function updateSelectionUI(){
      const count = selectedIds.size;
      const allCount = currentLayers.length;

      selCountEl.textContent = String(count);
      deleteBtn.disabled = count === 0;

      const enableSelectAll = hasUserScanned && allCount >= 2;
      chkAll.disabled = !enableSelectAll;
      selectAllWrap.classList.toggle('is-disabled', !enableSelectAll);

      if (!enableSelectAll) {
        chkAll.checked = false;
        chkAll.indeterminate = false;
        return;
      }

      const allSelected = allCount > 0 && count === allCount;
      const noneSelected = count === 0;
      chkAll.checked = allSelected;
      chkAll.indeterminate = !noneSelected && !allSelected;
    }

    function updateScanButtonLabel(){
      scanBtnLabel.textContent = scannedOnce ? 'Rescan' : 'Scan';
      scanBtn.title = scannedOnce ? 'Rescan selection' : 'Scan selection';
    }

    function renderLayers(payload){
      const { layers = [] } = payload || {};
      currentLayers = layers.slice();
      selectedIds = new Set();

      if (!layers.length){
        listEl.innerHTML = '';
        setEmpty('No hidden layers found in the current selection.');
        emptyEl.style.display = '';
        updateSelectionUI();
        return;
      }
      emptyEl.style.display = 'none';

      const html = layers.map(item => `
        <div class="layer-row" data-id="${item.id}" title="${escapeAttr(item.name)}">
          <div class="layer-left">
            <label class="chk-wrap">
              <input class="chk" type="checkbox" data-id="${item.id}" aria-label="Select ${escapeAttr(item.name)}" />
              <span class="chk-icon" aria-hidden="true">
                <!-- Unchecked -->
                <svg class="icon-unchecked" viewBox="0 0 24 24" fill="none">
                  <path d="M5 21C4.45 21 3.97917 20.8042 3.5875 20.4125C3.19583 20.0208 3 19.55 3 19V5C3 4.45 3.19583 3.97917 3.5875 3.5875C3.97917 3.19583 4.45 3 5 3H19C19.55 3 20.0208 3.19583 20.4125 3.5875C20.8042 3.97917 21 4.45 21 5V19C21 19.55 20.8042 20.0208 20.4125 20.4125C20.0208 20.8042 19.55 21 19 21H5ZM5 19H19V5H5V19Z" fill="#000"/>
                </svg>
                <!-- Checked -->
                <svg class="icon-checked" viewBox="0 0 24 24" fill="none">
                  <path d="M10.6 13.4L8.45 11.25C8.26667 11.0667 8.03333 10.975 7.75 10.975C7.46667 10.975 7.23333 11.0667 7.05 11.25C6.86667 11.4333 6.775 11.6667 6.775 11.95C6.775 12.2333 6.86667 12.4667 7.05 12.65L9.9 15.5C10.1 15.7 10.3333 15.8 10.6 15.8C10.8667 15.8 11.1 15.7 11.3 15.5L16.95 9.85C17.1333 9.66667 17.225 9.43333 17.225 9.15C17.225 8.86667 17.1333 8.63333 16.95 8.45C16.7667 8.26667 16.5333 8.175 16.25 8.175C15.9667 8.175 15.7333 8.26667 15.55 8.45L10.6 13.4ZM5 21C4.45 21 3.97917 20.8042 3.5875 20.4125C3.19583 20.0208 3 19.55 3 19V5C3 4.45 3.19583 3.97917 3.5875 3.5875C3.97917 3.19583 4.45 3 5 3H19C19.55 3 20.0208 3.19583 20.4125 3.5875C20.8042 3.97917 21 4.45 21 5V19C21 19.55 20.8042 20.0208 20.4125 20.4125C20.0208 20.8042 19.55 21 19 21H5Z" fill="#4caf4f"/>
                </svg>
              </span>
              <span class="layer-name">${escapeHtml(item.name)}</span>
            </label>
            ${item.isInstance ? '<span class="badge" title="Instance">INSTANCE</span>' : ''}
          </div>

          <button class="target-btn" aria-label="Focus ${escapeAttr(item.name)}" data-id="${item.id}" title="Focus">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="7"></circle>
              <line x1="12" y1="1" x2="12" y2="5"></line>
              <line x1="12" y1="19" x2="12" y2="23"></line>
              <line x1="1" y1="12" x2="5" y2="12"></line>
              <line x1="19" y1="12" x2="23" y2="12"></line>
              <circle cx="12" cy="12" r="1.5"></circle>
            </svg>
          </button>
        </div>
      `).join('');

      listEl.innerHTML = html;
      updateSelectionUI();
    }

    // --- Events ---
    scanBtn.addEventListener('click', () => {
      hasUserScanned = true;
      parent.postMessage({ pluginMessage: { type: 'search-again' } }, '*');
    });

    deleteBtn.addEventListener('click', () => {
      const ids = Array.from(selectedIds);
      if (!ids.length) return;
      deleteBtn.disabled = true;
      parent.postMessage({ pluginMessage: { type: 'delete-selected', ids } }, '*');
    });

    // Select All
    chkAll.addEventListener('change', () => {
      if (chkAll.disabled) return;
      const allCount = currentLayers.length;
      if (!allCount) {
        chkAll.checked = false;
        chkAll.indeterminate = false;
        return;
      }
      if (chkAll.checked) {
        selectedIds = new Set(currentLayers.map(l => l.id));
        listEl.querySelectorAll('.chk').forEach(ch => (ch.checked = true));
      } else {
        selectedIds.clear();
        listEl.querySelectorAll('.chk').forEach(ch => (ch.checked = false));
      }
      updateSelectionUI();
    });

    // Row checkbox
    listEl.addEventListener('change', (e) => {
      const chk = e.target.closest('.chk');
      if (!chk) return;
      const id = chk.dataset.id;
      if (!id) return;
      if (chk.checked) selectedIds.add(id);
      else selectedIds.delete(id);
      updateSelectionUI();
    });

    // Target icon click
    listEl.addEventListener('click', (e) => {
      const targetBtn = e.target.closest('.target-btn');
      if (!targetBtn) return;
      const id = targetBtn.dataset.id;
      if (!id) return;
      parent.postMessage({ pluginMessage: { type: 'zoom-to-layer', id } }, '*');

      const row = targetBtn.closest('.layer-row');
      const chk = row ? row.querySelector('.chk') : null;
      if (chk) {
        chk.checked = true;
        selectedIds.add(id);
        updateSelectionUI();
      }
    });

    // --- Messages from plugin ---
    window.onmessage = (event) => {
      const msg = event.data && event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'render-layers') {
        if (hasUserScanned) scannedOnce = true;
        updateScanButtonLabel();
        renderLayers(msg);
      }

      if (msg.type === 'prompt-selection') {
        renderLayers({ layers: [] });
        setEmpty(EMPTY_HINT);
        if (!hasUserScanned) scannedOnce = false;
        updateScanButtonLabel();
      }

      if (msg.type === 'deleted-ids' && Array.isArray(msg.ids)) {
        const gone = new Set(msg.ids);
        currentLayers = currentLayers.filter(l => !gone.has(l.id));
        selectedIds = new Set([...selectedIds].filter(id => !gone.has(id)));
        msg.ids.forEach((id) => {
          const row = listEl.querySelector(`.layer-row[data-id="${(id+'').replace(/"/g,'\\"')}"]`);
          if (row) row.remove();
        });
        if (currentLayers.length === 0) {
          setEmpty('No hidden layers found in the current selection.');
          emptyEl.style.display = '';
        }
        updateSelectionUI();
      }
    };

    // Init
    chkAll.disabled = true; chkAll.checked = false; chkAll.indeterminate = false;
    selectAllWrap.classList.add('is-disabled');
    setEmpty(EMPTY_HINT);
    updateScanButtonLabel();
    emptyEl.style.display = '';
    updateSelectionUI();
  </script>
</body>
</html>
